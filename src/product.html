<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Page</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link href="./output.css" rel="stylesheet" />
    <script>
      async function loadContent() {
        // Load header
        const headerResponse = await fetch("header.html");
        const headerData = await headerResponse.text();
        document.getElementById("header").innerHTML = headerData;

        // Load footer
        const footerResponse = await fetch("footer.html");
        const footerData = await footerResponse.text();
        document.getElementById("footer").innerHTML = footerData;

        // Show the main content after loading header and footer
        document.getElementById("main-content").style.display = "block";
      }

      // Load content when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("main-content").style.display = "none"; // Hide main content initially
        loadContent();
      });

      // Fetch and populate product details
      async function loadProductDetails() {
        const productName = getProductNameFromURL();
        console.log("Fetching details for product:", productName);

        try {
          const response = await fetch(
            `product.php?name=${encodeURIComponent(productName)}`,
          );
          console.log("Received response from product.php");

          const data = await response.json();
          console.log("Product data received:", data);

          if (data.error) {
            console.error("Error in data:", data.error);
            document.getElementById("product-details").innerHTML =
              `<p class="text-red-500">${data.error}</p>`;
            return;
          }

          // Populate main product data
          document.getElementById("product-name").textContent = productName;
          document.getElementById("product-category").textContent =
            data.category;
          if (data.sale_price != null) {
            document.getElementById("price-container").style.display = "block";
            document.getElementById("product-sale-price").textContent =
              data.sale_price;
            document.getElementById("product-original-price").textContent =
              data.price;
          } else {
            document.getElementById("price-container").style.display = "none";
            document.getElementById("product-price").textContent = data.price;
          }
          document.getElementById("product-description").textContent =
            data.description;
          document.getElementById("product-details-text").innerHTML =
            data.details;

          console.log("Product main details populated.");

          // Populate images
          const imageGallery = document.getElementById("product-images");
          const mainProductImage =
            document.getElementById("main-product-image");

          // Set the first image as the main image by default
          mainProductImage.style.backgroundImage = `url('${data.images[0]}')`;

          imageGallery.innerHTML = ""; // Clear any placeholders

          data.images.forEach((url, index) => {
            const imgDiv = document.createElement("div");
            imgDiv.classList.add(
              "h-32",
              "w-32",
              "rounded-lg",
              "bg-gray-300",
              "bg-cover",
              "bg-center",
              "cursor-pointer",
            );
            imgDiv.style.backgroundImage = `url('${url}')`;

            // Set the first thumbnail as selected by default
            if (index === 0)
              imgDiv.classList.add("ring-1", "ring-gray-500", "brightness-90");

            // Add click event to set as main image and highlight selected thumbnail
            imgDiv.addEventListener("click", () => {
              // Update main image
              mainProductImage.style.backgroundImage = `url('${url}')`;
              console.log(`Main image updated to URL: ${url}`);

              // Remove selection styles from all thumbnails
              document
                .querySelectorAll("#product-images div")
                .forEach((div) => {
                  div.classList.remove(
                    "ring-1",
                    "ring-gray-500",
                    "brightness-90",
                  );
                });

              // Add selection styles to the clicked thumbnail
              imgDiv.classList.add("ring-1", "ring-gray-500", "brightness-90");
            });

            imageGallery.appendChild(imgDiv);
            console.log(`Image ${index + 1} added with URL: ${url}`);
          });

          // Populate sizes
          const sizeButtons = document.getElementById("size-buttons");
          sizeButtons.innerHTML = ""; // Clear previous sizes
          data.sizes.forEach((size, index) => {
            const button = document.createElement("button");
            button.className =
              "size-button transform rounded-md border border-gray-300 py-2 transition duration-300 ease-in-out hover:border-blue-400 hover:bg-blue-300 hover:text-white";
            button.textContent = size.size;
            button.onclick = () => selectSize(button);
            if (size.stock > 0) {
              sizeButtons.appendChild(button);
            } else {
              const noSizesMessage = document.createElement("p");
              noSizesMessage.classList.add("text-red-500");
              noSizesMessage.textContent = "No sizes available"; // Set the message text
              sizeButtons.appendChild(noSizesMessage); // Append the message to the sizeButtons
            }
            console.log(`Size button added: ${size.size}`);
          });
          console.log("All sizes populated.");
        } catch (error) {
          console.error("Error loading product details:", error);
        }
      }

      // Get product name from URL
      function getProductNameFromURL() {
        const params = new URLSearchParams(window.location.search);
        const name = params.get("name") || "Default Product Name";
        console.log("Product name from URL:", name);
        return name;
      }

      // Add selected style to size button
      function selectSize(button) {
        console.log("Selecting size:", button.textContent);
        document.querySelectorAll(".size-button").forEach((btn) => {
          btn.classList.remove("bg-blue-500", "text-white", "border-blue-500");
          btn.classList.add("border-gray-300", "text-gray-900");
        });
        button.classList.add("bg-blue-500", "text-white", "border-blue-500");
        console.log("Size selected:", button.textContent);
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded, initializing page content.");
        document.getElementById("main-content").style.display = "none";
        loadContent();
        loadProductDetails();
      });
    </script>
  </head>
  <body class="bg-gray-100">
    <!-- Header Include -->
    <div id="header"></div>

    <div id="main-content" style="display: none">
      <!-- Product Section -->
      <section class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
        <div class="relative h-full">
          <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            <!-- Image Gallery -->
            <div class="rounded-lg bg-white p-4 shadow">
              <!-- Main Product Image -->
              <div
                id="main-product-image"
                class="aspect-square rounded-lg bg-gray-200 bg-cover bg-center"
              ></div>

              <!-- Thumbnail Images -->
              <div id="product-images" class="mt-4 flex gap-4"></div>

              <!-- Product Description -->
              <p id="product-description" class="mt-4 text-gray-600"></p>
            </div>

            <!-- Product Details -->
            <div class="flex flex-col gap-8 rounded-lg bg-white p-6 shadow">
              <div>
                <h6
                  id="product-category"
                  class="mb-3 font-medium text-zinc-700"
                ></h6>
                <h1
                  id="product-name"
                  class="text-4xl font-medium text-zinc-900"
                ></h1>
              </div>

              <div id="price-container">
                <span
                  id="product-sale-price"
                  class="text-xl font-bold text-red-500"
                ></span>
                <span
                  id="product-original-price"
                  class="text-xl text-zinc-500 line-through"
                ></span>
              </div>
              <div>
                <span
                  id="product-price"
                  class="text-xl font-medium text-zinc-700"
                ></span>
              </div>

              <!-- Size Selection -->
              <div>
                <div class="mb-4 flex items-baseline justify-between">
                  <h3 class="text-xl font-medium text-zinc-900">Select Size</h3>
                  <a
                    href="../assets/size_chart.png"
                    class="inline-block border-b-2 border-transparent text-zinc-700 hover:border-black hover:text-black"
                    >Size Chart</a
                  >
                </div>
                <div id="size-buttons" class="grid grid-cols-4 gap-2"></div>
              </div>

              <!-- Add to Bag Button -->
              <div class="flex flex-1 items-end">
                <button
                  class="w-full rounded-full bg-zinc-900 px-12 py-4 text-xl font-medium text-white hover:bg-zinc-900/90"
                >
                  Add to Bag
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Details Section -->
        <div class="mt-12">
          <div class="rounded-lg bg-white p-6 shadow">
            <h3 class="text-xl font-bold text-gray-900">Details</h3>
            <p id="product-details-text" class="mt-4 text-gray-700"></p>
          </div>
        </div>

        <!-- Shipping and Returns -->
        <div class="mt-6">
          <div class="rounded-lg bg-white p-6 shadow">
            <h3 class="text-xl font-bold text-gray-900">
              Shipping and Returns
            </h3>
            Your order of S$75 or more gets free standard delivery.
            <ul class="ml-6 mt-4 list-disc text-gray-700">
              <li>Standard delivered 1-3 Business Days</li>
              <li>
                Orders are processed and delivered Monday-Friday (excluding
                public holidays).
              </li>
            </ul>
            <br />
            SoleGood members enjoy free returns. Exclusions apply.
          </div>
        </div>
      </section>
    </div>

    <!-- Footer Include -->
    <div id="footer"></div>
  </body>
</html>
