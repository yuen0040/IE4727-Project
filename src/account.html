<!-- TODO redirect if not logged in -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=logout"
    />
    <link href="./output.css" rel="stylesheet" />
    <title>Manage Order</title>
    <script>
      async function loadContent() {
        // Load header
        const headerResponse = await fetch("header.html");
        const headerData = await headerResponse.text();
        document.getElementById("header").outerHTML = headerData;

        // Load footer
        const footerResponse = await fetch("footer.html");
        const footerData = await footerResponse.text();
        document.getElementById("footer").outerHTML = footerData;

        // Show the main content after loading header and footer
        document.getElementById("main-content").style.display = "block";
      }

      // Load content when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("main-content").style.display = "none"; // Hide main content initially
        loadContent();
      });
    </script>
  </head>
  <body>
    <div id="header"></div>
    <main class="mx-auto w-full max-w-[1400px] p-4 md:p-12" id="main-content">
      <div class="mb-8 flex flex-wrap items-center justify-between gap-8">
        <h1 class="text-4xl font-medium">My Account</h1>
        <button
          class="flex items-center justify-center gap-2 rounded-full border border-red-300 py-2 pl-5 pr-3 font-medium text-red-700 transition-colors hover:bg-red-50"
        >
          Logout
          <span class="material-symbols-outlined"> logout </span>
        </button>
      </div>
      <div class="mb-12 flex border-b border-zinc-200 text-lg" role="tablist">
        <button
          class="cursor-pointer border-b-2 border-zinc-900 px-3 py-2 text-zinc-900 transition-colors hover:bg-zinc-50 focus-visible:outline"
          role="tab"
          id="details-tab"
          onclick="onTabClick(false)"
        >
          Account Details
        </button>
        <button
          class="cursor-pointer border-b-2 border-transparent px-3 py-2 text-zinc-500 transition-colors hover:bg-zinc-50"
          role="tab"
          id="history-tab"
          onclick="onTabClick(true)"
        >
          Order History
        </button>
      </div>
      <section
        id="details"
        class="hidden flex-col gap-12 opacity-0 transition-opacity duration-300"
      >
        <div class="flex flex-col gap-4 md:flex-row">
          <h6 class="w-60 text-2xl font-medium text-zinc-900">
            Personal Details
          </h6>
          <div class="flex flex-col items-start gap-4 text-zinc-900">
            <div>
              <p class="text-sm font-medium text-zinc-700">Name</p>
              <p id="user-name">Loading...</p>
            </div>
            <div>
              <p class="text-sm font-medium text-zinc-700">Gender</p>
              <p id="user-gender">Unspecified</p>
            </div>
            <button class="font-medium underline">Edit</button>
          </div>
        </div>
        <div class="flex flex-col gap-4 md:flex-row">
          <h6 class="w-60 text-2xl font-medium text-zinc-900">Login Details</h6>
          <div class="flex flex-col items-start gap-4 text-zinc-900">
            <div>
              <p class="text-sm font-medium text-zinc-700">Email</p>
              <p id="user-email">Loading...</p>
            </div>
            <div>
              <p class="text-sm font-medium text-zinc-700">Password</p>
              <p>*********</p>
            </div>
            <button class="font-medium underline">Edit</button>
          </div>
        </div>
        <div class="flex flex-col gap-4 md:flex-row">
          <h6 class="w-60 text-2xl font-medium text-zinc-900">
            Address Details
          </h6>
          <div class="flex flex-col items-start gap-4 text-zinc-900">
            <div>
              <p class="text-sm font-medium text-zinc-700">Address</p>
              <p id="user-address">Loading...</p>
            </div>
            <div>
              <p class="text-sm font-medium text-zinc-700">Postal Code</p>
              <p id="user-postal">Loading...</p>
            </div>
            <div>
              <p class="text-sm font-medium text-zinc-700">Phone Number</p>
              <p id="user-phone">Loading...</p>
            </div>
            <button class="font-medium underline">Edit</button>
          </div>
        </div>
      </section>
      <!-- Order history tab -->
      <section
        id="history"
        class="hidden flex-col gap-8 opacity-0 transition-opacity duration-300"
      ></section>
    </main>
    <div id="footer"></div>
    <script>
      const fetchDetails = () => {
        fetch("getAccountDetails.php?details=true")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("user-name").innerText =
              data.first_name + " " + data.last_name;
            if (data.gender) {
              document.getElementById("user-gender").innerText = data.gender;
            }
            document.getElementById("user-email").innerText = data.email;
            document.getElementById("user-address").innerText = data.address
              ? data.address
              : "None";
            document.getElementById("user-phone").innerText = data.phone_number
              ? data.phone_number
              : "None";
            document.getElementById("user-postal").innerText = data.postal_code
              ? data.postal_code
              : "None";
          });
      };

      const fetchOrders = () => {
        let ordersHtml = "";
        fetch("getAccountDetails.php")
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            data.forEach((order, index) => {
              let images = "";
              const urls = order.image_urls.split("|");
              urls.forEach((url) => {
                images += `<div class="size-24 bg-zinc-200">
                          <img src="${url}" alt="order item" class="size-full object-cover" />
                        </div>`;
              });
              ordersHtml += `<div class="flex flex-wrap items-start gap-8">
                            <div class="flex-grow">
                              <div class="mb-6">
                                <h6 class="mb-1 text-2xl font-medium text-zinc-900">
                                  ${new Date(order.date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })} | $${order.total}
                                </h6>
                                <p class="text-zinc-700">Order number: ${order.id}</p>
                              </div>
                              <div class="flex flex-wrap gap-3">
                                ${images}
                              </div>
                            </div>
                            <a
                              class="flex min-w-fit items-center justify-center rounded-full border border-zinc-200 px-5 py-2 font-medium transition-colors hover:bg-zinc-100"
                              href="manageOrder?id=${order.id}"
                            >
                              View or Edit
                            </a>
                          </div>`;
              if (index !== data.length - 1)
                ordersHtml += `<div class="h-px bg-zinc-200"></div>`;
            });
            document.getElementById("history").innerHTML = ordersHtml;
          });
      };

      const showDetails = (show) => {
        const details = document.getElementById("details");
        const historyView = document.getElementById("history");
        const detailsTab = document.getElementById("details-tab");
        const historyTab = document.getElementById("history-tab");
        if (show) {
          fetchDetails();
          historyView.classList.replace("opacity-1", "opacity-0");
          setTimeout(() => {
            details.classList.replace("hidden", "flex");
            details.classList.replace("opacity-0", "opacity-1");
            historyView.classList.replace("flex", "hidden");
          }, 300);

          detailsTab.classList.replace("border-transparent", "border-zinc-900");
          detailsTab.classList.replace("text-zinc-500", "text-zinc-900");
          historyTab.classList.replace("border-zinc-900", "border-transparent");
          historyTab.classList.replace("text-zinc-900", "text-zinc-500");
        } else {
          fetchOrders();
          details.classList.replace("opacity-1", "opacity-0");
          setTimeout(() => {
            historyView.classList.replace("hidden", "flex");
            historyView.classList.replace("opacity-0", "opacity-1");
            details.classList.replace("flex", "hidden");
          }, 300);

          historyTab.classList.replace("border-transparent", "border-zinc-900");
          historyTab.classList.replace("text-zinc-500", "text-zinc-900");
          detailsTab.classList.replace("border-zinc-900", "border-transparent");
          detailsTab.classList.replace("text-zinc-900", "text-zinc-500");
        }
      };

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const history = urlParams.get("history");
      if (history) {
        showDetails(false);
      } else {
        showDetails(true);
      }

      const onTabClick = (orderHistoryTab) => {
        let url = new URL(window.location.href);
        if (orderHistoryTab) {
          url.searchParams.set("history", "true");
          window.history.pushState(window.history.state, "", url.href);
          showDetails(false);
        } else {
          url.searchParams.delete("history");
          window.history.pushState(window.history.state, "", url.href);
          showDetails(true);
        }
      };
    </script>
  </body>
</html>
